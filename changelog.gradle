import groovy.json.JsonSlurper

task makeChangelog {
	group 'convertigo'
	
	doLast {
		def jsonSlurper = new JsonSlurper()
		def url = 'https://api.github.com/repos/convertigo/convertigo/milestones'
		def json = jsonSlurper.parseText(new URL(url).text)
		def milestone = json.find { it.title == convertigoVersion }.number
		url = ('https://api.github.com/repos/convertigo/convertigo/issues?'
		+ "milestone=${milestone}")
		json = jsonSlurper.parseText(new URL(url).text)
		def tickets = ['new feature':[:], 'improvement':[:], 'bug':[:]]
		json.each {
			def label = it.labels.find { tickets.containsKey(it.name) }
			if (label != null) {
				tickets[label.name]["${it.number}"] = "[#${it.number}](${it.html_url}) ${it.title}"
			}
		}
		
		def state = 0
		def redo = true
		def changelog = ''
		def addAtTheEnd = ''
		
		def handleCategory = { line, inc, key, name ->
			inc *= 5
			if (state == 1 + inc) { // search new feature
				def m = (line =~ /#### (.*)/)
				if (m.matches() && m[0][1] == "${name}:") {
					state += 1
				} else if (!line.isEmpty()) {
					state += 2
					redo = true
				}
				if (!redo) {
					changelog += "${line}\n"
				}
			} else if (state == 2 + inc) { // space new feature
				changelog += "${line}\n"
				state += 2
			} else if (state == 3 + inc) { // add new feature part
				if (!tickets[key].isEmpty()) {
					changelog += "#### ${name}:\n\n"
					state += 2
					redo = true
				} else {
					state += 3
				}
			} else if (state == 4 + inc) { // filter new feature
				if (line.isEmpty()) {
					state += 1
				} else {
					changelog += "${line}\n"
					def m = (line =~ /- .*?\[#(\d+)\]/)
					if (m.find()) {
						tickets[key].remove m[0][1]
					}
				}
			} else if (state == 5 + inc) { // add new feature
				tickets[key].values().sort().each {
					changelog += "- * ${it}\n"
				}
				changelog += '\n'
				state += 1
				redo = true
			} else {
				return false
			}
			return true
		}
		
		def changelog_file = file('CHANGELOG.md')
		changelog_file.eachLine {
			redo = true
			while (redo) {
				redo = false
				if (state == 0) { // search version
					def m = (it =~ /## (.*)/)
					if (m.matches()) {
						if (m[0][1] == convertigoVersion) {
							state += 1
						} else {
							changelog += "## $convertigoVersion\n\n"
							addAtTheEnd = '---\n\n'
							redo = true
							state += 3
						}
					}
					if (!redo) {
						changelog += "${it}\n"
					}
				} else if (handleCategory(it, 0, 'new feature', 'New Features')) {
				} else if (handleCategory(it, 1, 'improvement', 'Improvements')) {
				} else if (handleCategory(it, 2, 'bug', 'Bug Fixes')) {
				} else if (state == 16) { // add separator
					changelog += addAtTheEnd
					state += 1
					redo = true
				} else {
					changelog += "${it}\n"
				}
			}
		}
		
		println changelog
		changelog_file.text = changelog
	}
}